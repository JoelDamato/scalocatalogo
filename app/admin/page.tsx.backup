'use client'

import { useState, useEffect } from 'react'
import { supabase } from '../../src/lib/supabase'
import Link from 'next/link'
import AdminAuth from "../../src/components/AdminAuth"
import AdminNavbar from "../../src/components/AdminNavbar"
import { useAuth } from "../../src/hooks/useAuth"
import { toast } from 'react-toastify'
import { confirmAlert } from 'react-confirm-alert'
import 'react-confirm-alert/src/react-confirm-alert.css'
import { createButtonProps } from '../../src/utils/buttonStyles'

interface Producto {
  id: string
  nombre: string
  descripcion: string | null
  categoria: string | null
  precio: number | null
  costo: number | null
  foto_url: string | null
  publicado: boolean
  created_at: string
  updated_at: string
}

interface ProductoPopular {
  id: string
  nombre: string
  foto_url: string | null
  precio: number | null
  costo: number | null
  total_selecciones: number
}

export default function AdminPage() {
  const { isAuthenticated, loading: authLoading } = useAuth()
  const [productos, setProductos] = useState<Producto[]>([])
  const [productosPopulares, setProductosPopulares] = useState<ProductoPopular[]>([])
  const [productosFacturados, setProductosFacturados] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  const [mostrarFormulario, setMostrarFormulario] = useState(false)
  const [mostrarCargaCSV, setMostrarCargaCSV] = useState(false)
  const [archivoCSV, setArchivoCSV] = useState<File | null>(null)
  const [cargandoCSV, setCargandoCSV] = useState(false)
  const [productoEditando, setProductoEditando] = useState<Producto | null>(null)
  const [isVisible, setIsVisible] = useState(false)
  const [formData, setFormData] = useState({
    nombre: '',
    descripcion: '',
    categoria: '',
    precio: '',
    costo: '',
    porcentaje_ganancia: '50', // 50% por defecto
    foto_url: '',
    publicado: true
  })
  const [calcularPrecioAutomatico, setCalcularPrecioAutomatico] = useState(true)
  const [subiendoImagen, setSubiendoImagen] = useState(false)
  const [busquedaAdmin, setBusquedaAdmin] = useState('')
  const [productosFiltrados, setProductosFiltrados] = useState<Producto[]>([])

  // Efecto para recalcular precio cuando cambian costo/porcentaje y está en modo automático
  useEffect(() => {
    console.log('useEffect ejecutado:', { 
      calcularPrecioAutomatico, 
      costo: formData.costo, 
      porcentaje: formData.porcentaje_ganancia 
    })
    
    if (calcularPrecioAutomatico && formData.costo && formData.porcentaje_ganancia) {
      const costoNum = parseFloat(formData.costo)
      const porcentajeNum = parseFloat(formData.porcentaje_ganancia)
      
      if (!isNaN(costoNum) && !isNaN(porcentajeNum) && costoNum > 0) {
        const nuevoPrecio = (costoNum * (1 + porcentajeNum / 100)).toFixed(2)
        console.log('Calculando precio:', { costoNum, porcentajeNum, nuevoPrecio })
        
        if (nuevoPrecio !== formData.precio) {
          console.log('Actualizando precio de', formData.precio, 'a', nuevoPrecio)
          setFormData(prev => ({ ...prev, precio: nuevoPrecio }))
        }
      }
    }
  }, [formData.costo, formData.porcentaje_ganancia, calcularPrecioAutomatico])

  // Efecto para filtrar productos
  useEffect(() => {
    if (busquedaAdmin.trim() === '') {
      setProductosFiltrados(productos)
    } else {
      const filtrados = productos.filter(producto =>
        producto.nombre.toLowerCase().includes(busquedaAdmin.toLowerCase()) ||
        (producto.descripcion && producto.descripcion.toLowerCase().includes(busquedaAdmin.toLowerCase())) ||
        (producto.categoria && producto.categoria.toLowerCase().includes(busquedaAdmin.toLowerCase()))
      )
      setProductosFiltrados(filtrados)
    }
  }, [productos, busquedaAdmin])

  // Función para calcular precio automáticamente
  const calcularPrecioVenta = (costo: string, porcentaje: string, forzarCalculo: boolean = false) => {
    if ((calcularPrecioAutomatico || forzarCalculo) && costo && porcentaje) {
      const costoNum = parseFloat(costo)
      const porcentajeNum = parseFloat(porcentaje)
      if (!isNaN(costoNum) && !isNaN(porcentajeNum) && costoNum > 0) {
        const precio = costoNum * (1 + porcentajeNum / 100)
        return precio.toFixed(2)
      }
    }
    return ''
  }

  // Manejar cambios en costo
  const manejarCambioCosto = (valor: string) => {
    console.log('Cambiando costo a:', valor)
    setFormData(prev => ({
      ...prev,
      costo: valor
    }))
  }

  // Manejar cambios en porcentaje
  const manejarCambioPorcentaje = (valor: string) => {
    console.log('Cambiando porcentaje a:', valor)
    setFormData(prev => ({
      ...prev,
      porcentaje_ganancia: valor
    }))
  }

  useEffect(() => {
    if (isAuthenticated && !authLoading) {
      setIsVisible(true)
      cargarDatos()
    }
  }, [isAuthenticated, authLoading])

  const cargarDatos = async () => {
    await Promise.all([
      cargarProductos(),
      cargarProductosPopulares(),
      cargarProductosFacturados()
    ])
    setLoading(false)
  }

  const cargarProductos = async () => {
    try {
      const { data, error } = await supabase
        .from('productos')
        .select('*')
        .order('created_at', { ascending: false })

      if (error) {
        console.error('Error cargando productos:', error)
        return
      }

      setProductos(data || [])
    } catch (error) {
      console.error('Error:', error)
    }
  }

  const cargarProductosPopulares = async () => {
    try {
      const { data: selecciones, error } = await supabase
        .from('producto_selecciones')
        .select(`
          producto_id,
          productos (
            id,
            nombre,
            foto_url,
            precio,
            costo
          )
        `)

      if (error) {
        console.error('Error cargando selecciones:', error)
        return
      }

      const conteoSelecciones: { [key: string]: { producto: any, count: number } } = {}
      
      selecciones?.forEach((seleccion: any) => {
        const productoId = seleccion.producto_id
        if (conteoSelecciones[productoId]) {
          conteoSelecciones[productoId].count++
        } else {
          conteoSelecciones[productoId] = {
            producto: seleccion.productos,
            count: 1
          }
        }
      })

      const productosPopularesArray = Object.values(conteoSelecciones)
        .map(item => ({
          id: item.producto.id,
          nombre: item.producto.nombre,
          foto_url: item.producto.foto_url,
          precio: item.producto.precio,
          costo: item.producto.costo,
          total_selecciones: item.count
        }))
        .sort((a, b) => b.total_selecciones - a.total_selecciones)
        .slice(0, 5)

      setProductosPopulares(productosPopularesArray)
    } catch (error) {
      console.error('Error:', error)
    }
  }

  const cargarProductosFacturados = async () => {
    try {
      const { data: ordenes, error } = await supabase
        .from('ordenes')
        .select('productos')

      if (error) {
        console.error('Error cargando facturas:', error)
      return
    }

      // Procesar todas las facturas para calcular productos más facturados
      const facturacion: { [key: string]: { nombre: string, total: number, cantidad: number } } = {}

      ordenes?.forEach(orden => {
        orden.productos?.forEach((item: any) => {
          const productoId = item.producto_id || item.nombre // Usar nombre como fallback
          if (!facturacion[productoId]) {
            facturacion[productoId] = {
              nombre: item.nombre,
              total: 0,
              cantidad: 0
            }
          }
          facturacion[productoId].total += item.subtotal || (item.precio_unitario * item.cantidad)
          facturacion[productoId].cantidad += item.cantidad
        })
      })

      const productosFacturadosArray = Object.entries(facturacion)
        .map(([id, data]) => ({
          id,
          nombre: data.nombre,
          total_facturado: data.total,
          cantidad_vendida: data.cantidad
        }))
        .sort((a, b) => b.total_facturado - a.total_facturado)
        .slice(0, 5)

      setProductosFacturados(productosFacturadosArray)
    } catch (error) {
      console.error('Error cargando productos facturados:', error)
    }
  }

  const subirImagen = async (archivo: File) => {
    setSubiendoImagen(true)
    try {
      const formData = new FormData()
      formData.append('file', archivo)
      formData.append('folder', 'productos')

      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData
      })

      if (response.ok) {
        const data = await response.json()
        return data.url
        } else {
        const errorData = await response.json()
        throw new Error(errorData.error || 'Error al subir imagen')
      }
    } catch (error) {
      console.error('Error subiendo imagen:', error)
      toast.error('Error al subir la imagen: ' + (error as Error).message)
      return null
    } finally {
      setSubiendoImagen(false)
    }
  }

  const manejarCambioImagen = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const archivo = e.target.files?.[0]
    if (archivo) {
      const url = await subirImagen(archivo)
      if (url) {
        setFormData(prev => ({ ...prev, foto_url: url }))
      }
    }
  }

  const manejarSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    if (!formData.nombre.trim()) {
      toast.warn('El nombre es obligatorio')
      return
    }

    try {
      const productoData = {
        nombre: formData.nombre.trim(),
        descripcion: formData.descripcion.trim() || null,
        categoria: formData.categoria.trim() || null,
        precio: formData.precio ? parseFloat(formData.precio) : null,
        costo: formData.costo ? parseFloat(formData.costo) : null,
        foto_url: formData.foto_url || null,
        publicado: formData.publicado
      }

      if (productoEditando) {
        const { error } = await supabase
          .from('productos')
          .update(productoData)
          .eq('id', productoEditando.id)

        if (error) throw error
        toast.success('Producto actualizado correctamente')
      } else {
        const { error } = await supabase
          .from('productos')
          .insert([productoData])

        if (error) throw error
        toast.success('Producto agregado correctamente')
      }

      setFormData({
        nombre: '',
        descripcion: '',
        categoria: '',
        precio: '',
        costo: '',
        porcentaje_ganancia: '50',
        foto_url: '',
        publicado: true
      })
      setProductoEditando(null)
      setMostrarFormulario(false)
      await cargarProductos()
    } catch (error) {
      console.error('Error:', error)
      toast.error('Error al guardar el producto')
    }
  }

  const editarProducto = (producto: Producto) => {
    setProductoEditando(producto)
    
    // Calcular porcentaje si tenemos costo y precio
    let porcentajeCalculado = '50' // default
    if (producto.costo && producto.precio && producto.costo > 0) {
      const porcentaje = ((producto.precio - producto.costo) / producto.costo) * 100
      porcentajeCalculado = porcentaje.toFixed(0)
    }
    
    setFormData({
      nombre: producto.nombre,
      descripcion: producto.descripcion || '',
      categoria: producto.categoria || '',
      precio: producto.precio?.toString() || '',
      costo: producto.costo?.toString() || '',
      porcentaje_ganancia: porcentajeCalculado,
      foto_url: producto.foto_url || '',
      publicado: producto.publicado
    })
    setCalcularPrecioAutomatico(true) // Activar cálculo automático al editar
    setMostrarFormulario(true)
  }

  const cancelarEdicion = () => {
    setProductoEditando(null)
    setFormData({
      nombre: '',
      descripcion: '',
      categoria: '',
      precio: '',
      costo: '',
      porcentaje_ganancia: '50',
      foto_url: '',
      publicado: true
    })
    setCalcularPrecioAutomatico(true)
    setMostrarFormulario(false)
  }

  const eliminarProducto = async (id: string) => {
    const producto = productos.find(p => p.id === id)
    
    confirmAlert({
      title: '🗑️ Confirmar eliminación',
      message: `¿Estás seguro de que deseas eliminar "${producto?.nombre || 'este producto'}"?`,
      buttons: [
        {
          label: 'Cancelar',
          onClick: () => {
            toast.info('Eliminación cancelada')
          },
          className: 'confirm-cancel-button'
        },
        {
          label: 'Eliminar',
          onClick: async () => {
            try {
              const { error } = await supabase
                .from('productos')
                .delete()
                .eq('id', id)

              if (error) throw error

              toast.success('Producto eliminado correctamente')
              await cargarProductos()
            } catch (error) {
              console.error('Error:', error)
              toast.error('Error al eliminar el producto')
            }
          },
          className: 'confirm-delete-button'
        }
      ],
      customUI: ({ onClose, title, message }) => (
        <div style={{
          background: '#FFFFFF',
          borderRadius: '16px',
          padding: '2rem',
          boxShadow: '0 20px 40px rgba(0, 0, 0, 0.15)',
          maxWidth: '400px',
          fontFamily: 'system-ui, -apple-system, sans-serif'
        }}>
          <h2 style={{
            fontSize: '1.25rem',
            fontWeight: '600',
            color: '#111827',
            marginBottom: '1rem',
            textAlign: 'center'
          }}>
            {title}
          </h2>
          <p style={{
            color: '#6B7280',
            marginBottom: '2rem',
            textAlign: 'center',
            lineHeight: '1.5'
          }}>
            {message}
          </p>
          <div style={{
            display: 'flex',
            gap: '1rem',
            justifyContent: 'center'
          }}>
            <button
              onClick={() => {
                toast.info('Eliminación cancelada')
                onClose()
              }}
              style={{
                background: '#F3F4F6',
                color: '#374151',
                border: 'none',
                padding: '0.75rem 1.5rem',
                borderRadius: '8px',
                fontSize: '0.875rem',
                fontWeight: '500',
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}
            >
              Cancelar
            </button>
            <button
              onClick={async () => {
                try {
                  const { error } = await supabase
                    .from('productos')
                    .delete()
                    .eq('id', id)

                  if (error) throw error

                  toast.success('Producto eliminado correctamente')
                  await cargarProductos()
                } catch (error) {
                  console.error('Error:', error)
                  toast.error('Error al eliminar el producto')
                }
                onClose()
              }}
              style={{
                background: '#EF4444',
                color: '#FFFFFF',
                border: 'none',
                padding: '0.75rem 1.5rem',
                borderRadius: '8px',
                fontSize: '0.875rem',
                fontWeight: '500',
                cursor: 'pointer',
                transition: 'all 0.2s ease'
              }}
            >
              Eliminar
            </button>
          </div>
        </div>
      )
    })
  }

  const togglePublicado = async (id: string, publicado: boolean) => {
    try {
      const { error } = await supabase
        .from('productos')
        .update({ publicado })
        .eq('id', id)

      if (error) throw error

      await cargarProductos()
    } catch (error) {
      console.error('Error:', error)
      toast.error('Error al actualizar el producto')
    }
  }

  const descargarProductosCSV = () => {
    try {
      // Crear encabezados CSV
      const headers = ['Nombre', 'Descripción', 'Categoría', 'Precio', 'Costo', 'Publicado', 'Foto URL']
      
      // Convertir productos a filas CSV
      const filas = productos.map(producto => [
        `"${(producto.nombre || '').replace(/"/g, '""')}"`,
        `"${(producto.descripcion || '').replace(/"/g, '""')}"`,
        `"${(producto.categoria || '').replace(/"/g, '""')}"`,
        producto.precio || '',
        producto.costo || '',
        producto.publicado ? 'Sí' : 'No',
        `"${(producto.foto_url || '').replace(/"/g, '""')}"`
      ])

      // Crear contenido CSV
      const csvContent = [headers.join(','), ...filas.map(fila => fila.join(','))].join('\n')
      
      // Crear y descargar archivo
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' })
      const link = document.createElement('a')
      const url = URL.createObjectURL(blob)
      link.setAttribute('href', url)
      link.setAttribute('download', `productos-${new Date().toISOString().split('T')[0]}.csv`)
      link.style.visibility = 'hidden'
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      
      toast.success('¡Productos descargados exitosamente!')
    } catch (error) {
      console.error('Error descargando CSV:', error)
      toast.error('Error al descargar los productos')
    }
  }

  const manejarArchivoCSV = (e: React.ChangeEvent<HTMLInputElement>) => {
    const archivo = e.target.files?.[0]
    if (archivo && archivo.type === 'text/csv') {
      setArchivoCSV(archivo)
    } else {
      toast.warn('Por favor selecciona un archivo CSV válido')
      e.target.value = ''
    }
  }

  const cargarProductosCSV = async () => {
    if (!archivoCSV) {
      toast.warn('Por favor selecciona un archivo CSV')
      return
    }

    setCargandoCSV(true)
    try {
      const texto = await archivoCSV.text()
      const lineas = texto.split('\n').filter(linea => linea.trim())
      
      if (lineas.length < 2) {
        toast.warn('El archivo CSV debe tener al menos una fila de encabezados y una de datos')
        return
      }

      // Saltar la primera línea (encabezados)
      const filasProductos = lineas.slice(1)
      const productosParaInsertar = []

      for (const fila of filasProductos) {
        // Parsear CSV considerando comillas
        const campos = []
        let campoActual = ''
        let dentroComillas = false
        
        for (let i = 0; i < fila.length; i++) {
          const char = fila[i]
          if (char === '"' && (i === 0 || fila[i-1] === ',')) {
            dentroComillas = true
          } else if (char === '"' && dentroComillas && (i === fila.length - 1 || fila[i+1] === ',')) {
            dentroComillas = false
          } else if (char === ',' && !dentroComillas) {
            campos.push(campoActual.trim())
            campoActual = ''
          } else {
            campoActual += char
          }
        }
        campos.push(campoActual.trim())

        const [nombre, descripcion, categoria, precio, costo, publicado, foto_url] = campos

        if (nombre && nombre.replace(/"/g, '').trim()) {
          const producto = {
            nombre: nombre.replace(/"/g, '').trim(),
            descripcion: descripcion ? descripcion.replace(/"/g, '').trim() : null,
            categoria: categoria ? categoria.replace(/"/g, '').trim() : null,
            precio: precio && precio.trim() ? parseFloat(precio) : null,
            costo: costo && costo.trim() ? parseFloat(costo) : null,
            publicado: publicado ? (publicado.toLowerCase().includes('sí') || publicado.toLowerCase().includes('si') || publicado.toLowerCase().includes('true')) : true,
            foto_url: foto_url ? foto_url.replace(/"/g, '').trim() : null
          }
          productosParaInsertar.push(producto)
        }
      }

      if (productosParaInsertar.length === 0) {
        toast.warn('No se encontraron productos válidos en el archivo CSV')
      return
    }

      // Insertar productos en la base de datos
      const { error } = await supabase
        .from('productos')
        .insert(productosParaInsertar)

      if (error) throw error

      toast.success(`¡${productosParaInsertar.length} productos cargados exitosamente!`)
      setMostrarCargaCSV(false)
      setArchivoCSV(null)
      await cargarProductos()
      
      // Limpiar el input file
      const fileInput = document.querySelector('input[type="file"]') as HTMLInputElement
      if (fileInput) fileInput.value = ''
      
    } catch (error) {
      console.error('Error cargando CSV:', error)
      toast.error('Error al cargar los productos desde el archivo CSV')
    } finally {
      setCargandoCSV(false)
    }
  }

  if (authLoading) {
    return (
      <div style={{
        minHeight: '100vh',
        background: '#F9FAFB',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        fontFamily: 'system-ui, -apple-system, sans-serif'
      }}>
        <div style={{
          background: '#FFFFFF',
          borderRadius: '12px',
          padding: '2rem',
          boxShadow: '0 4px 12px rgba(0, 0, 0, 0.05)',
          textAlign: 'center'
        }}>
          <div style={{
            fontSize: '1.2rem',
            color: '#111827',
            marginBottom: '1rem'
          }}>
            Verificando autenticación...
          </div>
        </div>
      </div>
    )
  }

  if (!isAuthenticated) {
    return <AdminAuth onAuthSuccess={() => {}} />
  }

  if (loading) {
    return (
      <div style={{
        minHeight: '100vh',
        background: '#F9FAFB',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center'
      }}>
        <div style={{ textAlign: 'center' }}>
          <div style={{
            width: '60px',
            height: '60px',
            border: '4px solid #E5E7EB',
            borderTop: '4px solid #111827',
            borderRadius: '50%',
            animation: 'spin 1s linear infinite',
            margin: '0 auto 1rem'
          }}></div>
          <p style={{ color: '#111827', fontSize: '1.1rem' }}>Cargando productos...</p>
        </div>
      </div>
    )
  }

  return (
    <div style={{
      minHeight: '100vh',
      background: '#F9FAFB',
      paddingTop: '100px',
      fontFamily: 'system-ui, -apple-system, sans-serif'
    }}>
      <AdminNavbar />

      <main style={{
        position: 'relative',
        zIndex: 3,
        maxWidth: '1400px',
        margin: '0 auto',
        padding: '2rem 1rem',
        minHeight: '100vh'
      }}>
        {/* Header */}
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          marginBottom: '2rem',
          flexWrap: 'wrap',
          gap: '1rem',
          opacity: isVisible ? 1 : 0,
          transform: isVisible ? 'translateY(0)' : 'translateY(30px)',
          transition: 'all 1s ease-out'
        }}>
          <div>
            <h1 style={{
              fontSize: 'clamp(1.875rem, 5vw, 2.5rem)',
              fontWeight: '700',
              color: '#111827',
              marginBottom: '0.5rem',
              letterSpacing: '-0.025em'
            }}>
              Panel de Administración
            </h1>
            <p style={{
              color: '#6B7280',
              fontSize: '1.1rem'
            }}>
              Gestiona productos y visualiza estadísticas
            </p>
          </div>

          <div style={{
            display: 'flex',
            gap: '1rem',
            flexWrap: 'wrap',
            justifyContent: 'center'
          }}>
            <Link href="/" style={{ textDecoration: 'none' }}>
              <button {...createButtonProps({ variant: 'secondary', size: 'md' })}>
                ← Ir al Inicio
              </button>
            </Link>
            
          
          </div>
        </div>

        {/* Productos y Rankings */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: '1fr 400px',
          gap: '2rem',
          marginBottom: '2rem',
          opacity: isVisible ? 1 : 0,
          transform: isVisible ? 'translateY(0)' : 'translateY(30px)',
          transition: 'all 1s ease-out 0.2s'
        }}>
          {/* Productos principales */}
          <div style={{
            background: '#FFFFFF',
            padding: '2rem',
            borderRadius: '16px',
            border: '1px solid #E5E7EB',
            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.05)'
          }}>
            {/* Buscador y controles */}
            <div style={{
              marginBottom: '1.5rem',
              borderBottom: '1px solid #E5E7EB',
              paddingBottom: '1.5rem'
            }}>
              <div style={{
                display: 'grid',
                gridTemplateColumns: '1fr auto',
                gap: '1rem',
                alignItems: 'center',
                marginBottom: '1rem'
              }}>
                <div style={{ position: 'relative' }}>
                  <input
                    type="text"
                    placeholder="Buscar productos por nombre, descripción o categoría..."
                    value={busquedaAdmin}
                    onChange={(e) => setBusquedaAdmin(e.target.value)}
                    style={{
                      width: '100%',
                      padding: '0.75rem 1rem 0.75rem 2.5rem',
                      borderRadius: '10px',
                      border: '1px solid #D1D5DB',
                      fontSize: '0.875rem',
                      outline: 'none',
                      transition: 'all 0.3s ease',
                      boxSizing: 'border-box',
                      background: '#FFFFFF',
                      boxShadow: '0 2px 4px rgba(0, 0, 0, 0.05)'
                    }}
                    onFocus={(e) => {
                      e.target.style.borderColor = '#3B82F6'
                      e.target.style.boxShadow = '0 4px 8px rgba(59, 130, 246, 0.15)'
                    }}
                    onBlur={(e) => {
                      e.target.style.borderColor = '#D1D5DB'
                      e.target.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.05)'
                    }}
                  />
                  {/* Ícono de búsqueda */}
                  <div style={{
                    position: 'absolute',
                    left: '0.75rem',
                    top: '50%',
                    transform: 'translateY(-50%)',
                    color: '#9CA3AF',
                    pointerEvents: 'none'
                  }}>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="11" cy="11" r="8" stroke="currentColor" strokeWidth="2"/>
                      <path d="m21 21-4.35-4.35" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                    </svg>
                  </div>
                </div>
                
                <div style={{
                  fontSize: '0.875rem',
                  color: '#6B7280',
                  textAlign: 'right',
                  fontWeight: '500',
                  background: '#F8F9FA',
                  padding: '0.5rem 1rem',
                  borderRadius: '8px',
                  border: '1px solid #E5E7EB'
                }}>
                  📋 {productosFiltrados.length} de {productos.length} productos
                </div>
              </div>
          </div>

            {/* Botones de acción */}
          <div style={{
            display: 'flex',
            gap: '1rem',
            marginBottom: '2rem',
            borderBottom: '1px solid #E5E7EB',
            paddingBottom: '1rem',
            flexWrap: 'wrap'
          }}>
              <button
              onClick={() => setMostrarFormulario(!mostrarFormulario)}
              {...createButtonProps({ variant: 'success', size: 'md' })}
            >
              {mostrarFormulario ? 'Cerrar Formulario' : '+ Agregar Producto'}
            </button>
            
            <button
              onClick={descargarProductosCSV}
              disabled={productos.length === 0}
              {...createButtonProps({ variant: 'info', size: 'md', disabled: productos.length === 0 })}
            >
              📥 Descargar CSV
            </button>
            
            <button
              onClick={() => setMostrarCargaCSV(!mostrarCargaCSV)}
              {...createButtonProps({ variant: 'warning', size: 'md' })}
            >
              📤 {mostrarCargaCSV ? 'Cerrar Carga' : 'Cargar CSV'}
            </button>
            
          </div>

          {/* Sección de carga CSV */}
          {mostrarCargaCSV && (
            <div style={{
              background: '#F8F9FA',
              padding: '1.5rem',
              borderRadius: '12px',
              border: '1px solid #E5E7EB',
              marginBottom: '2rem'
            }}>
              <h3 style={{
                fontSize: '1.125rem',
                fontWeight: '600',
                color: '#111827',
                marginBottom: '1rem',
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem'
              }}>
                📤 Cargar Productos desde CSV
              </h3>
              
              <div style={{
                background: '#FEF3C7',
                border: '1px solid #F59E0B',
                borderRadius: '8px',
                padding: '1rem',
                marginBottom: '1rem'
              }}>
                <p style={{
                  color: '#92400E',
                  fontSize: '0.875rem',
                  margin: '0 0 0.5rem 0',
                  fontWeight: '500'
                }}>
                  📋 Formato del archivo CSV:
                </p>
                <p style={{
                  color: '#92400E',
                  fontSize: '0.75rem',
                  margin: 0,
                  fontFamily: 'monospace',
                  lineHeight: '1.4'
                }}>
                  Nombre,Descripción,Categoría,Precio,Costo,Publicado,Foto URL<br/>
                  "Producto 1","Descripción del producto","Categoría",10.99,5.50,Sí,"https://..."<br/>
                  "Producto 2","Otra descripción","Otra categoría",15.00,8.00,No,""
                </p>
              </div>
              
              <div style={{
                display: 'flex',
                gap: '1rem',
                alignItems: 'end',
                flexWrap: 'wrap'
              }}>
                <div style={{ flex: 1, minWidth: '200px' }}>
                  <label style={{
                    display: 'block',
                    fontSize: '0.875rem',
                    fontWeight: '500',
                    color: '#374151',
                    marginBottom: '0.5rem'
                  }}>
                    Seleccionar archivo CSV
                  </label>
                  <input
                    type="file"
                    accept=".csv"
                    onChange={manejarArchivoCSV}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      borderRadius: '8px',
                      border: '1px solid #D1D5DB',
                      fontSize: '0.875rem',
                      backgroundColor: '#FFFFFF',
                      cursor: 'pointer',
                      boxSizing: 'border-box'
                    }}
                  />
                </div>
                
                <button
                  onClick={cargarProductosCSV}
                  disabled={!archivoCSV || cargandoCSV}
                  {...createButtonProps({ 
                    variant: 'success', 
                    size: 'md', 
                    disabled: !archivoCSV || cargandoCSV 
                  })}
                >
                  {cargandoCSV ? 'Cargando...' : '📤 Cargar'}
                </button>
              </div>
            </div>
          )}

            {/* Lista de Productos */}
            <div style={{
              display: 'flex',
              flexDirection: 'column',
              gap: '1rem',
              marginTop: '2rem'
            }}>
              {productosFiltrados.map((producto, index) => (
                <div key={producto.id} style={{
                  background: '#FFFFFF',
                  borderRadius: '12px',
                  padding: '1.25rem',
                  border: '1px solid #E5E7EB',
                  boxShadow: '0 2px 8px rgba(0, 0, 0, 0.05)',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '1.5rem',
                  transition: 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)',
                  position: 'relative',
                  overflow: 'hidden'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.transform = 'translateY(-2px) scale(1.01)'
                  e.currentTarget.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.12)'
                  e.currentTarget.style.border = '1px solid #D1D5DB'
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.transform = 'translateY(0) scale(1)'
                  e.currentTarget.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.05)'
                  e.currentTarget.style.border = '1px solid #E5E7EB'
                }}>
                  {/* Indicador de estado */}
                  <div style={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    right: 0,
                    height: '4px',
                    background: producto.publicado 
                      ? 'linear-gradient(90deg, #10B981 0%, #059669 100%)' 
                      : 'linear-gradient(90deg, #EF4444 0%, #DC2626 100%)',
                    borderRadius: '12px 12px 0 0'
                  }} />

                  {/* Foto */}
                  <div style={{
                    width: '60px',
                    height: '60px',
                    borderRadius: '12px',
                    overflow: 'hidden',
                    flexShrink: 0,
                    background: 'linear-gradient(135deg, #F8F9FA 0%, #E5E7EB 100%)',
                    border: '1px solid #E5E7EB',
                    boxShadow: '0 2px 4px rgba(0, 0, 0, 0.05)'
                  }}>
                    {producto.foto_url ? (
                      <img
                        src={producto.foto_url}
                        alt={producto.nombre}
                        style={{
                          width: '100%',
                          height: '100%',
                          objectFit: 'contain',
                          background: '#FFFFFF'
                        }}
                      />
                    ) : (
                      <div style={{
                        width: '100%',
                        height: '100%',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: '#9CA3AF',
                        fontSize: '1.5rem'
                      }}>
                        📦
                      </div>
                    )}
                  </div>

                  {/* Información principal */}
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <h3 style={{
                      color: '#111827',
                      fontSize: '1.125rem',
                      fontWeight: '600',
                      marginBottom: '0.5rem',
                      lineHeight: '1.3',
                      overflow: 'hidden',
                      textOverflow: 'ellipsis',
                      whiteSpace: 'nowrap'
                    }}>
                      {producto.nombre}
                    </h3>
                    
                    {producto.descripcion && (
                      <p style={{
                        color: '#6B7280',
                        fontSize: '0.875rem',
                        lineHeight: '1.4',
                        marginBottom: '0.5rem',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: 'nowrap'
                      }}>
                        {producto.descripcion}
                      </p>
                    )}

                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '1.5rem',
                      fontSize: '0.875rem',
                      flexWrap: 'wrap'
                    }}>
                      {producto.categoria && (
                        <span style={{
                          background: '#F3F4F6',
                          color: '#374151',
                          padding: '0.25rem 0.75rem',
                          borderRadius: '6px',
                          fontSize: '0.75rem',
                          fontWeight: '500'
                        }}>
                          {producto.categoria}
                        </span>
                      )}
                      
                      <span style={{
                        color: '#111827',
                        fontWeight: '600'
                      }}>
                        Precio: ${producto.precio?.toFixed(2) || 'No definido'}
                      </span>
                      
                      <span style={{
                        color: '#6B7280'
                      }}>
                        Costo: ${producto.costo?.toFixed(2) || 'No definido'}
                      </span>
                      
                      <span style={{
                        color: producto.publicado ? '#10B981' : '#EF4444',
                        fontWeight: '500',
                        fontSize: '0.75rem',
                        textTransform: 'uppercase',
                        letterSpacing: '0.05em'
                      }}>
                        {producto.publicado ? '✓ Publicado' : '✕ No publicado'}
                      </span>
                    </div>
                  </div>

                  {/* Botones de acción */}
                  <div style={{
                    display: 'flex',
                    gap: '0.75rem',
                    flexShrink: 0,
                    alignItems: 'center'
                  }}>
                    <button
                      onClick={() => togglePublicado(producto.id, !producto.publicado)}
                      {...createButtonProps({ 
                        variant: producto.publicado ? 'danger' : 'success', 
                        size: 'sm' 
                      })}
                      style={{
                        ...createButtonProps({ 
                          variant: producto.publicado ? 'danger' : 'success', 
                          size: 'sm' 
                        }).style,
                        minWidth: '80px'
                      }}
                    >
                      {producto.publicado ? 'Ocultar' : 'Publicar'}
                    </button>
                    
                    <button
                      onClick={() => editarProducto(producto)}
                      {...createButtonProps({ variant: 'info', size: 'sm' })}
                    >
                      ✏️
                    </button>
                    
                    <button
                      onClick={() => eliminarProducto(producto.id)}
                      {...createButtonProps({ variant: 'danger', size: 'sm' })}
                    >
                      🗑️
                    </button>
                  </div>
                </div>
              ))}
            </div>

            {/* Mensaje cuando no hay productos */}
            {productosFiltrados.length === 0 && (
              <div style={{
                textAlign: 'center',
                padding: '3rem 1rem',
                color: '#6B7280',
                background: '#F9FAFB',
                borderRadius: '12px',
                border: '1px solid #E5E7EB'
              }}>
                <div style={{
                  fontSize: '3rem',
                  marginBottom: '1rem'
                }}>
                  📦
                </div>
                <h3 style={{
                  fontSize: '1.125rem',
                  fontWeight: '600',
                  color: '#111827',
                  marginBottom: '0.5rem'
                }}>
                  {busquedaAdmin ? 'No se encontraron productos' : 'No hay productos'}
                </h3>
                <p style={{
                  fontSize: '0.875rem',
                  color: '#6B7280',
                  marginBottom: '1.5rem'
                }}>
                  {busquedaAdmin 
                    ? `No hay productos que coincidan con "${busquedaAdmin}"`
                    : 'Comienza agregando tu primer producto'
                  }
                </p>
                {!busquedaAdmin && (
                  <button
                    onClick={() => setMostrarFormulario(true)}
                    {...createButtonProps({ variant: 'primary', size: 'md' })}
                  >
                    + Crear Primer Producto
                  </button>
                )}
              </div>
            )}
          </div>

          {/* Formulario de producto */}
          {mostrarFormulario && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0, 0, 0, 0.8)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 2000,
              padding: '1rem'
            }}>
              <div style={{
                background: '#FFFFFF',
                padding: '2.5rem',
                borderRadius: '20px',
                border: '1px solid #E5E7EB',
                maxWidth: '600px',
                width: '100%',
                maxHeight: '90vh',
                overflowY: 'auto',
                boxShadow: '0 25px 50px rgba(0, 0, 0, 0.3)'
              }}>
                <h3 style={{
                  fontSize: '1.8rem',
                  fontWeight: '800',
                  color: '#111827',
                  marginBottom: '1.5rem',
                  textAlign: 'center'
                }}>
                  {editandoProducto ? '✏️ Editar Producto' : '➕ Nuevo Producto'}
                </h3>
                
                <form onSubmit={manejarSubmit}>
                      <p style={{
                        fontSize: '0.75rem',
                        color: '#6B7280',
                        margin: '0 0 0.25rem 0'
                      }}>
                        Costo
                      </p>
                      <p style={{
                        fontSize: '1rem',
                        fontWeight: '600',
                        color: '#111827',
                        margin: 0
                      }}>
                        ${producto.costo?.toFixed(2) || 'No definido'}
                      </p>
                      </div>
            </div>

            <div style={{
              display: 'flex',
                    justifyContent: 'space-between',
                      alignItems: 'center',
                    marginBottom: '1rem'
                  }}>
                    <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                    }}>
                      <span style={{
                        fontSize: '0.875rem',
                        color: '#6B7280'
                      }}>
                        Estado:
                      </span>
                      <span style={{
                        fontSize: '0.875rem',
                        fontWeight: '500',
                        color: producto.publicado ? '#10B981' : '#EF4444'
                      }}>
                        {producto.publicado ? 'Publicado' : 'No publicado'}
                      </span>
                    </div>
                    <button
                      onClick={() => togglePublicado(producto.id, !producto.publicado)}
                      {...createButtonProps({ 
                        variant: producto.publicado ? 'danger' : 'success', 
                        size: 'sm' 
                      })}
                    >
                      {producto.publicado ? 'Despublicar' : 'Publicar'}
                    </button>
        </div>

        <div style={{
          display: 'flex',
                    gap: '0.5rem',
                    flexWrap: 'wrap'
        }}>
                    <button
                      onClick={() => editarProducto(producto)}
                      {...createButtonProps({ variant: 'info', size: 'sm' })}
                      style={{
                        ...createButtonProps({ variant: 'info', size: 'sm' }).style,
                        flex: 1
                      }}
                    >
                      ✏️ Editar
                    </button>
                    <button
                      onClick={() => eliminarProducto(producto.id)}
                      {...createButtonProps({ variant: 'danger', size: 'sm' })}
                      style={{
                        ...createButtonProps({ variant: 'danger', size: 'sm' }).style,
                        flex: 1
                      }}
                    >
                      🗑️ Eliminar
                    </button>
            </div>
                  </div>
                )
              ))}

              {productosFiltrados.length === 0 && (
              <div style={{
                  textAlign: 'center',
                  padding: '3rem',
                  color: '#6B7280',
                  gridColumn: '1 / -1'
                }}>
                  <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>
                    {busquedaAdmin ? '🔍' : '📦'}
                  </div>
                  <h3 style={{
                    fontSize: '1.25rem',
                    fontWeight: '600',
                    color: '#111827',
                    marginBottom: '0.5rem'
                  }}>
                    {busquedaAdmin ? 'No se encontraron productos' : 'No hay productos'}
                  </h3>
                  <p>
                    {busquedaAdmin 
                      ? `No hay productos que coincidan con "${busquedaAdmin}"`
                      : 'Agrega tu primer producto para comenzar'
                    }
                </p>
              </div>
            )}
          </div>
          </div>

          {/* Rankings en formato cuadrado */}
        <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '1.5rem'
          }}>
            {/* Ranking de Productos Más Seleccionados */}
          {productosPopulares.length > 0 && (
              <div style={{
                background: '#FFFFFF',
              padding: '1.5rem',
                borderRadius: '16px',
                border: '1px solid #E5E7EB',
                boxShadow: '0 4px 12px rgba(0, 0, 0, 0.05)'
        }}>
          <h3 style={{
                  fontSize: '1.125rem',
                fontWeight: '600',
                  color: '#111827',
                marginBottom: '1rem',
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem'
              }}>
                  🏆 Más Seleccionados
          </h3>
              
            <div style={{
              display: 'flex',
                flexDirection: 'column',
                  gap: '0.75rem'
              }}>
                  {productosPopulares.slice(0, 5).map((producto, index) => (
              <div key={producto.id} style={{
                      background: '#F9FAFB',
                      padding: '0.75rem',
                      borderRadius: '8px',
                  display: 'flex',
                  alignItems: 'center',
                    justifyContent: 'space-between',
                      border: '1px solid #E5E7EB',
                      transition: 'all 0.2s ease'
              }}
              onMouseOver={(e) => {
                      e.currentTarget.style.background = '#F3F4F6'
                      e.currentTarget.style.transform = 'translateX(2px)'
              }}
              onMouseOut={(e) => {
                      e.currentTarget.style.background = '#F9FAFB'
                    e.currentTarget.style.transform = 'translateX(0)'
              }}>
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                        gap: '0.75rem',
                      flex: 1
                }}>
                  <div style={{
                          width: '24px',
                          height: '24px',
                          borderRadius: '6px',
                          background: index === 0 ? '#F59E0B' :
                                     index === 1 ? '#6B7280' :
                                     index === 2 ? '#D97706' :
                                     '#9CA3AF',
                    display: 'flex',
                    alignItems: 'center',
                        justifyContent: 'center',
                          fontSize: '0.75rem',
                          fontWeight: '600',
                          color: '#FFFFFF'
                      }}>
                        {index + 1}
                  </div>
                  
                      <div style={{ flex: 1 }}>
                            <p style={{
                            fontWeight: '500',
                            fontSize: '0.875rem',
                            color: '#111827',
                margin: 0
                      }}>
                        {producto.nombre}
                            </p>
                    </div>
            </div>

              <div style={{
                        textAlign: 'right'
              }}>
                      <p style={{
                          fontSize: '0.875rem',
                    fontWeight: '600',
                          color: '#111827',
                          margin: 0
                      }}>
                        {producto.total_selecciones}
                </p>
                    </div>
                      </div>
                ))}
                  </div>
          </div>
        )}
                  
            {/* Ranking de Productos Más Facturados */}
            {productosFacturados.length > 0 && (
                  <div style={{
                background: '#FFFFFF',
              padding: '1.5rem',
                borderRadius: '16px',
                border: '1px solid #E5E7EB',
                boxShadow: '0 4px 12px rgba(0, 0, 0, 0.05)'
        }}>
          <h3 style={{
                  fontSize: '1.125rem',
                fontWeight: '600',
                  color: '#111827',
                marginBottom: '1rem',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem'
              }}>
                  💰 Más Facturados
          </h3>
                
            <div style={{
              display: 'flex',
                  flexDirection: 'column',
                  gap: '0.75rem'
                }}>
                  {productosFacturados.map((producto, index) => (
              <div key={producto.id} style={{
                      background: '#F9FAFB',
                      padding: '0.75rem',
                      borderRadius: '8px',
                  display: 'flex',
                  alignItems: 'center',
                      justifyContent: 'space-between',
                      border: '1px solid #E5E7EB',
                      transition: 'all 0.2s ease'
                      }}
                      onMouseOver={(e) => {
                      e.currentTarget.style.background = '#F3F4F6'
                      e.currentTarget.style.transform = 'translateX(2px)'
                      }}
                      onMouseOut={(e) => {
                      e.currentTarget.style.background = '#F9FAFB'
                      e.currentTarget.style.transform = 'translateX(0)'
              }}>
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                        gap: '0.75rem',
                        flex: 1
                }}>
                  <div style={{
                          width: '24px',
                          height: '24px',
                          borderRadius: '6px',
                          background: index === 0 ? '#10B981' :
                                     index === 1 ? '#6B7280' :
                                     index === 2 ? '#D97706' :
                                     '#9CA3AF',
                    display: 'flex',
                    alignItems: 'center',
              justifyContent: 'center',
                          fontSize: '0.75rem',
                          fontWeight: '600',
                          color: '#FFFFFF'
                        }}>
                          {index + 1}
                  </div>
                  
                        <div style={{ flex: 1 }}>
                      <p style={{
                            fontWeight: '500',
                            fontSize: '0.875rem',
                            color: '#111827',
                            margin: 0
                          }}>
                            {producto.nombre}
                </p>
                </div>
              </div>
            
              <div style={{
                        textAlign: 'right'
              }}>
          <p style={{
                          fontSize: '0.875rem',
                  fontWeight: '600',
                          color: '#111827',
                          margin: 0
                        }}>
                          ${producto.total_facturado.toFixed(2)}
                        </p>
                </div>
              </div>
            ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </main>

      {/* Modal de Formulario */}
      {mostrarFormulario && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0, 0, 0, 0.6)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          padding: '1rem'
        }}>
          <div style={{
            background: '#FFFFFF',
            borderRadius: '20px',
            padding: '2rem',
            maxWidth: '500px',
            width: '100%',
            maxHeight: '90vh',
            overflowY: 'auto',
            boxShadow: '0 20px 40px rgba(0, 0, 0, 0.15)',
            fontFamily: 'system-ui, -apple-system, sans-serif'
          }}>
            <div style={{
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              marginBottom: '2rem'
            }}>
              <h2 style={{
                color: '#111827',
                margin: 0,
              fontWeight: '700',
                fontSize: '1.5rem'
            }}>
              {productoEditando ? 'Editar Producto' : 'Nuevo Producto'}
              </h2>
              <button
                onClick={cancelarEdicion}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '1.5rem',
                  cursor: 'pointer',
                  color: '#6B7280',
                  padding: '0.5rem',
                  borderRadius: '6px',
                  transition: 'all 0.2s ease'
                }}
                onMouseOver={(e) => {
                  e.currentTarget.style.background = '#F3F4F6'
                  e.currentTarget.style.color = '#111827'
                }}
                onMouseOut={(e) => {
                  e.currentTarget.style.background = 'none'
                  e.currentTarget.style.color = '#6B7280'
                }}
              >
                ✕
              </button>
            </div>

            <form onSubmit={manejarSubmit}>
              <div style={{ marginBottom: '1.5rem' }}>
                <label style={{
                  display: 'block',
                  marginBottom: '0.5rem',
                  fontWeight: '500',
                  color: '#374151',
                  fontSize: '0.875rem'
                }}>
                  Nombre *
                </label>
                <input
                  type="text"
                  name="nombre"
                  value={formData.nombre}
                  onChange={(e) => setFormData({...formData, [e.target.name]: e.target.value})}
                  required
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #D1D5DB',
                    fontSize: '1rem',
                    outline: 'none',
                    transition: 'border-color 0.2s ease',
                    boxSizing: 'border-box'
                  }}
                  onFocus={(e) => {
                    e.target.style.borderColor = '#3B82F6'
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = '#D1D5DB'
                  }}
                />
              </div>
              
              <div style={{ marginBottom: '1.5rem' }}>
                <label style={{
                  display: 'block',
                  marginBottom: '0.5rem',
                  fontWeight: '500',
                  color: '#374151',
                  fontSize: '0.875rem'
                }}>
                  Descripción
                </label>
                <textarea
                  name="descripcion"
                  value={formData.descripcion}
                  onChange={(e) => setFormData({...formData, [e.target.name]: e.target.value})}
                  rows={3}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #D1D5DB',
                    fontSize: '1rem',
                    outline: 'none',
                    transition: 'border-color 0.2s ease',
                    resize: 'vertical',
                    fontFamily: 'system-ui, -apple-system, sans-serif',
                    boxSizing: 'border-box'
                  }}
                  onFocus={(e) => {
                    e.target.style.borderColor = '#3B82F6'
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = '#D1D5DB'
                  }}
                />
              </div>
              
              <div style={{ marginBottom: '1.5rem' }}>
                <label style={{
                  display: 'block',
                  marginBottom: '0.5rem',
                  fontWeight: '500',
                  color: '#374151',
                  fontSize: '0.875rem'
                }}>
                  Categoría
                </label>
                <input
                  type="text"
                  name="categoria"
                  value={formData.categoria}
                  onChange={(e) => setFormData({...formData, [e.target.name]: e.target.value})}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #D1D5DB',
                    fontSize: '1rem',
                    outline: 'none',
                    transition: 'border-color 0.2s ease',
                    boxSizing: 'border-box'
                  }}
                  onFocus={(e) => {
                    e.target.style.borderColor = '#3B82F6'
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = '#D1D5DB'
                  }}
                />
              </div>
              
              <div style={{
                display: 'grid',
                gridTemplateColumns: '1fr 1fr',
                gap: '1rem',
                marginBottom: '1.5rem'
              }}>
              <div>
                <label style={{
                  display: 'block',
                    marginBottom: '0.5rem',
                    fontWeight: '500',
                    color: '#374151',
                    fontSize: '0.875rem'
                  }}>
                    Costo *
                </label>
                <input
                  type="number"
                    name="costo"
                    value={formData.costo}
                    onChange={(e) => manejarCambioCosto(e.target.value)}
                  step="0.01"
                    min="0"
                    required
                  style={{
                    width: '100%',
                      padding: '0.75rem',
                      borderRadius: '8px',
                      border: '1px solid #D1D5DB',
                    fontSize: '1rem',
                    outline: 'none',
                      transition: 'border-color 0.2s ease',
                      boxSizing: 'border-box'
                  }}
                  onFocus={(e) => {
                      e.target.style.borderColor = '#3B82F6'
                  }}
                  onBlur={(e) => {
                      e.target.style.borderColor = '#D1D5DB'
                  }}
                />
              </div>
              <div>
                <label style={{
                  display: 'block',
                  marginBottom: '0.5rem',
                  fontWeight: '500',
                  color: '#374151',
                  fontSize: '0.875rem'
                }}>
                  % Ganancia
                </label>
                <input
                  type="number"
                  name="porcentaje_ganancia"
                  value={formData.porcentaje_ganancia}
                  onChange={(e) => manejarCambioPorcentaje(e.target.value)}
                  step="1"
                  min="0"
                  max="1000"
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #D1D5DB',
                    fontSize: '1rem',
                    outline: 'none',
                    transition: 'border-color 0.2s ease',
                    boxSizing: 'border-box'
                  }}
                  onFocus={(e) => {
                    e.target.style.borderColor = '#3B82F6'
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = '#D1D5DB'
                  }}
                />
                <p style={{
                  fontSize: '0.75rem',
                  color: '#6B7280',
                  marginTop: '0.25rem',
                  margin: '0.25rem 0 0 0'
                }}>
                  Porcentaje de ganancia sobre el costo
                </p>
              </div>
              </div>

              <div style={{
              display: 'grid',
              gridTemplateColumns: '1fr auto',
              gap: '1rem',
              marginBottom: '1.5rem',
              alignItems: 'end'
            }}>
                  <div>
                    <label style={{
                      display: 'block',
                  marginBottom: '0.5rem',
                  fontWeight: '500',
                  color: '#374151',
                  fontSize: '0.875rem'
                }}>
                  Precio de Venta
                    </label>
                    <input
                      type="number"
                  name="precio"
                  value={formData.precio}
                  onChange={(e) => {
                    setFormData({...formData, [e.target.name]: e.target.value})
                    if (e.target.value) {
                      setCalcularPrecioAutomatico(false)
                    }
                  }}
                  step="0.01"
                      min="0"
                  disabled={calcularPrecioAutomatico}
                  placeholder={calcularPrecioAutomatico ? 'Calculado automáticamente' : 'Precio manual'}
                      style={{
                        width: '100%',
                    padding: '0.75rem',
                        borderRadius: '8px',
                    border: '1px solid #D1D5DB',
                    fontSize: '1rem',
                        outline: 'none',
                    transition: 'border-color 0.2s ease',
                    boxSizing: 'border-box',
                    backgroundColor: calcularPrecioAutomatico ? '#F9FAFB' : '#FFFFFF',
                    color: calcularPrecioAutomatico ? '#6B7280' : '#111827'
                  }}
                  onFocus={(e) => {
                    if (!calcularPrecioAutomatico) {
                      e.target.style.borderColor = '#3B82F6'
                    }
                  }}
                  onBlur={(e) => {
                    e.target.style.borderColor = '#D1D5DB'
                  }}
                />
              </div>
              
              <div>
                <button
                  type="button"
                  onClick={() => {
                    setCalcularPrecioAutomatico(!calcularPrecioAutomatico)
                    if (!calcularPrecioAutomatico && formData.costo && formData.porcentaje_ganancia) {
                      // Recalcular precio cuando se activa el automático
                      const nuevoPrecio = calcularPrecioVenta(formData.costo, formData.porcentaje_ganancia, true)
                      setFormData(prev => ({ ...prev, precio: nuevoPrecio }))
                    }
                  }}
                  style={{
                    background: calcularPrecioAutomatico ? '#10B981' : '#6B7280',
                    color: '#FFFFFF',
                    border: 'none',
                    padding: '0.75rem 1rem',
                    borderRadius: '8px',
                    fontSize: '0.875rem',
                    fontWeight: '500',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease',
                    whiteSpace: 'nowrap'
                  }}
                  onMouseOver={(e) => {
                    e.currentTarget.style.opacity = '0.8'
                  }}
                  onMouseOut={(e) => {
                    e.currentTarget.style.opacity = '1'
                  }}
                >
                  {calcularPrecioAutomatico ? '🔄 Auto' : '✏️ Manual'}
                </button>
                  </div>
            </div>
                
            <div style={{ marginBottom: '1.5rem' }}>
                  <label style={{
                    display: 'block',
                marginBottom: '0.5rem',
                fontWeight: '500',
                color: '#374151',
                fontSize: '0.875rem'
              }}>
                Foto del Producto
                  </label>
                  <input
                  type="file"
                  accept="image/*"
                  onChange={manejarCambioImagen}
                    style={{
                      width: '100%',
                    padding: '0.75rem',
                    borderRadius: '8px',
                    border: '1px solid #D1D5DB',
                      fontSize: '1rem',
                      outline: 'none',
                    transition: 'border-color 0.2s ease',
                    backgroundColor: '#F9FAFB',
                    boxSizing: 'border-box'
                  }}
                />
                {formData.foto_url && (
                  <div style={{ marginTop: '0.5rem' }}>
                    <img
                      src={formData.foto_url}
                      alt="Preview"
                    style={{
                        width: '100px',
                        height: '100px',
                        objectFit: 'cover',
                        borderRadius: '8px',
                        border: '1px solid #E5E7EB'
                    }}
                  />
                </div>
                )}
              </div>
              
              <div style={{
                display: 'flex',
                alignItems: 'center',
                marginBottom: '2rem'
              }}>
                <input
                  type="checkbox"
                  name="publicado"
                  checked={formData.publicado}
                  onChange={(e) => setFormData({...formData, [e.target.name]: e.target.checked})}
                  style={{
                    marginRight: '0.5rem',
                    width: '1rem',
                    height: '1rem'
                  }}
                />
                <label style={{
                  fontWeight: '500',
                  color: '#374151',
                  fontSize: '0.875rem'
                }}>
                  Publicar producto inmediatamente
                </label>
              </div>
              
              <div style={{
                display: 'flex',
                gap: '1rem',
                justifyContent: 'flex-end'
              }}>
                <button
                  type="button"
                  onClick={cancelarEdicion}
                  style={{
                    background: '#FFFFFF',
                    color: '#6B7280',
                    border: '1px solid #D1D5DB',
                    padding: '0.75rem 1.5rem',
                    borderRadius: '8px',
                    fontSize: '0.875rem',
                    fontWeight: '500',
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                  onMouseOver={(e) => {
                    e.currentTarget.style.background = '#F3F4F6'
                    e.currentTarget.style.color = '#374151'
                  }}
                  onMouseOut={(e) => {
                    e.currentTarget.style.background = '#FFFFFF'
                    e.currentTarget.style.color = '#6B7280'
                  }}
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  disabled={subiendoImagen}
                  style={{
                    background: subiendoImagen ? '#9CA3AF' : '#3B82F6',
                    color: '#FFFFFF',
                    border: 'none',
                    padding: '0.75rem 1.5rem',
                    borderRadius: '8px',
                    fontSize: '0.875rem',
                    fontWeight: '500',
                    cursor: subiendoImagen ? 'not-allowed' : 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                  onMouseOver={(e) => {
                    if (!subiendoImagen) {
                      e.currentTarget.style.background = '#2563EB'
                  }
                  }}
                  onMouseOut={(e) => {
                    if (!subiendoImagen) {
                      e.currentTarget.style.background = '#3B82F6'
                    }
                  }}
                >
                  {subiendoImagen ? 'Subiendo imagen...' : (productoEditando ? 'Actualizar' : 'Crear Producto')}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  )
}
